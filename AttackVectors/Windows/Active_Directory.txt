Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2021-10-30T12:50:57-05:00

====== Active Directory ======
Created Saturday 30 October 2021

===== End goal =====
* Hashes are stored in  the Local  Security  Authority  Subsystem  Service  (LSASS).
* Gettings these hashes to be able to crack them is the end goal.
* LSASS runs as SYSTEM, as such we'll need a SYSTEM or Local Admin account in order to dump hashes from this memory space
* This means we'll have to privesc to admin on a local machine, and use mimikatz to dump creds/tickets


===== Kerberos Attacks =====

* SPN Scanning — finding services by requesting service principal names of a specific SPN class/type, and then [[+Kerberoasting]]
* Silver Ticket — forged Kerberos TGS service ticket
* Golden Ticket — forged Kerberos TGT authentication ticket
* MS14–068 Forged PAC Exploit — exploitation of the Kerberos vulnerability on Domain Controllers.


==== Kerberoasting ====
[[+Kerberoasting]]

==== Slow burn brute forcing ====
In order to prevent lock-outs during a brute-force attemps, we'll need to take the account policy into consideration.
This tool does exactly that: [[Tools:Windows:PowerShell:Spray-Passwords.ps1]]

==== Pass the hash ====
[[+PassTheHash]]

==== OverPass the hash ====
* The essence of the OPtH technique is to use the NTLM hash to get a Kerberos TGT to execute a command on the system.
* This Bypasses NTLM authentication altogether
* See [[+OverpassTheHash]]

==== Pass the Ticket (Silver ticket) ====
See [[+PassTheTicket (Silver ticket)]]


===== Active directory persistence =====
* This comes into play once you have sploited a domain, and you want to maintain access to it

==== Golden Tickets ====
* A Golden ticket is a forged TGT that gives total access to the domain
* See [[+Golden Ticket]]

==== Obtaining all hashes ====
Another way to gain persitence is to obtain all the password hashes.

=== Log into DC with DC admin account and use mimikatz ===
{{{code: lang="sh" linenumbers="False"
mimikatz "privilege::debug" "token::elevate" "lsadump::lsa /patch"
}}}


=== Stealing a copy ntds.dit  file ===
* The dist file contains all the Active Directory data
* Can be found here:
* %SystemRoot%\System32\Ntds.dit 

=== Perform DC synchronization with mimikatz ===
* This command should be run from a non-dc machine
* This will only succeed if the user executing the command is a domain-admin
{{{code: lang="sh" linenumbers="False"
mimikatz "lsadump::dcsync /user:username"
}}}





===== SEE =====
[[Technologies:Windows:Active Directory]]
[[Technologies:Portlist]]
https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#most-common-paths-to-ad-compromise
