Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2022-01-25T13:44:53-05:00

====== Kernel Exploitation ======
Created Tuesday 25 January 2022

First, you'll need a working kernel. If you're doing a challenge it should be provided, otherwise you'll need to compile one yourself: [[+Compiling a kernel|Compiling a kernel]]

You should end up with 2 files:
* vmlinuz*
* the RAM disk. Something like initramfs.cpio.gz or initrd*


===== Extracting the kernel =====
We'll extract the kernel to be able to extract ROP gadgets, which may be useful later on.
We'll use the [[+scripts:extract-image.sh|extract-image.sh]] script to this purpose:
{{{code: lang="sh" linenumbers="False"
$ ./extract-image.sh ./vmlinuz > vmlinux
}}}


===== Extracting the ROP gadgets =====
{{{code: lang="sh" linenumbers="False"
$ ROPgadget --binary ./vmlinux > gadgets.txt
}}}

* This will take a while, as the binary is huge compared to userland bins.

===== Manipulating the initramfs =====
We'll use gunzip and cpio to unpack and pack.

First time unpack
{{{code: lang="sh" linenumbers="False"
mkdir initramfs
cd initramfs
cp ../initramfs.cpio.gz .
gunzip ./initramfs.cpio.gz
cpio -idm < ./initramfs.cpio
rm initramfs.cpio
}}}


Pack 
{{{code: lang="sh" linenumbers="False"
cd initramfs && find . -print0 | cpio --null -ov --format=newc | gzip -9 > initramfs.cpio.gz && mv ./initramfs.cpio.gz ../
}}}



===== Changing the user that will open a session to root. =====
In order to have access to more data, we'd like to have our session open as root.
To do this, we'll need to add/update a line in /etc/inittab on the initramfs.

{{{code: lang="texinfo" linenumbers="False"
::once:-sh -c 'cat /etc/motd; setuidgid 0 sh; poweroff'
}}}

* Don't forget to change back to 1000 when live-testing the exploit

This will give us access to useful information like:
{{{code: lang="texinfo" linenumbers="False"
/proc/kallsyms
}}}

* Lists all addresses of all symbols loaded into the kernel. See [[Technologies:Linux:procfs|procfs]]



===== SEE =====
[[Technologies:Linux|Linux]]
